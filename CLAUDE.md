# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Browser extension that redirects YouTube URLs to Invidious instances when YouTube blocks access.

## Package Manager

This project uses **pnpm** (version 10.26.2 or compatible). Always use pnpm commands:
- `pnpm install` - Install dependencies
- `pnpm dev` - Start development server with hot-reload (Chrome dev mode)
- `pnpm build` - Build for both Chrome and Firefox
- `pnpm build:chrome` - Build Chrome version only
- `pnpm build:firefox` - Build Firefox version only
- `pnpm test` - Run tests (currently not configured)

## Development Workflow

### Hot-Reload Development
1. Run `pnpm dev` to start Vite dev server
2. Load `dist/` as unpacked extension in Chrome (`chrome://extensions/`)
3. Extension automatically reloads when you modify source files in `src/`
4. Changes to `manifest.json` require manual extension reload in Chrome

## Browser Extension Structure

### Current Implementation
- `manifest.json` - Manifest v3 configuration
- `src/content.js` - Content script that detects bot errors and shows popup
- `icons/` - Extension icons (16x16, 48x48, 128x128 PNG)
- `dist/` - Built extension (generated by Vite, load this as unpacked extension)

### How It Works
1. Content script runs on all YouTube pages
2. Detects "Sign in to confirm you're not a bot" error via DOM text matching
3. Extracts video ID from URL query parameter `v`
4. Shows injected popup offering to switch to Invidious
5. On user confirmation, redirects to `https://yewtu.be/watch?v=VIDEO_ID`

### Future Enhancements
- **Options page** - User configuration for Invidious instance selection
- **Storage** - Save user preferences with `chrome.storage.sync`
- **Popup** - Quick toggle to enable/disable extension

## Architecture Notes

### Redirection Logic
The extension should intercept YouTube URLs and redirect to equivalent Invidious URLs:
- Video: `youtube.com/watch?v=VIDEO_ID` → `invidious.instance/watch?v=VIDEO_ID`
- Channel: `youtube.com/channel/CHANNEL_ID` → `invidious.instance/channel/CHANNEL_ID`
- Playlist: `youtube.com/playlist?list=PLAYLIST_ID` → `invidious.instance/playlist?list=PLAYLIST_ID`

### Invidious Instances
Maintain a list of public Invidious instances with fallback options. Consider:
- Health checking instances
- User-configurable instance preference
- Automatic fallback if preferred instance is down

## Cross-Browser Compatibility

**Supported Browsers**: Chrome and Firefox (both use Manifest v3)

**Build System**:
- Single unified `manifest.json` for both browsers
- Both browsers use Manifest v3 (modern versions only)
- `browser_specific_settings.gecko.id` for Firefox (ignored by Chrome)
- Build scripts in `scripts/` directory:
  - `build.js` - Builds both browsers
  - `build-chrome.js` - Chrome only
  - `build-firefox.js` - Firefox only
- `webextension-polyfill` installed for cross-browser API compatibility

## Testing

Unit tests should cover:
- URL parsing and transformation logic
- Redirect decision logic (when to redirect vs. when not to)
- Storage operations for user preferences
